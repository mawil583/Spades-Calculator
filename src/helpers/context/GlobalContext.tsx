import { createContext, useReducer, ReactNode } from 'react';
import rootReducer, { initialState } from '../utils/rootReducer';
import { updateInput } from '../utils/helperFunctions';
import type { GlobalContextValue, UpdateInputArgs, Round } from '../../types';

export const GlobalContext = createContext<GlobalContextValue>({} as GlobalContextValue);

export const StateProvider = ({ children }: { children: ReactNode }) => {
  const [state, dispatch] = useReducer(rootReducer, initialState);

  const setCurrentRound = ({ input, fieldToUpdate, currentRound }: UpdateInputArgs) => {
    // Check if this is a team total update (fieldToUpdate contains "team")
    if (
      fieldToUpdate &&
      fieldToUpdate.includes('team') &&
      fieldToUpdate.includes('Total')
    ) {
      // This is a team total update, calculate individual values
      const teamNumber = fieldToUpdate.includes('team1') ? 1 : 2;
      const teamField =
        teamNumber === 1 ? 'team1BidsAndActuals' : 'team2BidsAndActuals';

      // Calculate individual values (divide by 2)
      // input is guaranteed to be a number in the team-total branch
      const numInput = input as number;
      const individualValue = Math.floor(numInput / 2);
      const remainder = numInput % 2;

      // Distribute the total between players
      const p1Value = individualValue + remainder; // First player gets the remainder

      // Mark both actuals as auto-generated for this team
      const autoGeneratedKey1 = teamNumber === 1 ? 'team1P1' : 'team2P1';
      const autoGeneratedKey2 = teamNumber === 1 ? 'team1P2' : 'team2P2';

      // Create updated round with both individual values and auto-generated tracking
      const updatedRound: Round = {
        ...currentRound,
        [teamField]: {
          ...currentRound[teamField],
          p1Actual: p1Value,
          p2Actual: individualValue,
        },
        autoGeneratedActuals: {
          ...currentRound.autoGeneratedActuals,
          [autoGeneratedKey1]: true,
          [autoGeneratedKey2]: true,
        } as Round['autoGeneratedActuals'],
      };

      dispatch({
        type: 'SET_CURRENT_ROUND',
        payload: {
          currentRound: updatedRound,
        },
      });
    } else if (fieldToUpdate && fieldToUpdate.includes('Actual')) {
      // This is an individual actual update, mark it as manually entered
      const teamNumber = fieldToUpdate.includes('team1') ? 1 : 2;
      const playerNumber = fieldToUpdate.includes('p1Actual') ? 'P1' : 'P2';
      const autoGeneratedKey = `team${teamNumber}${playerNumber}`;

      // Normal single field update
      const updatedRound = updateInput({ input, fieldToUpdate, currentRound });

      // Mark this actual as manually entered (not auto-generated)
      const finalUpdatedRound: Round = {
        ...updatedRound,
        autoGeneratedActuals: {
          ...updatedRound.autoGeneratedActuals,
          [autoGeneratedKey]: false,
        } as Round['autoGeneratedActuals'],
      };

      dispatch({
        type: 'SET_CURRENT_ROUND',
        payload: {
          currentRound: finalUpdatedRound,
        },
      });
    } else {
      // Normal single field update (not an actual)
      const updatedRound = updateInput({ input, fieldToUpdate, currentRound });
      dispatch({
        type: 'SET_CURRENT_ROUND',
        payload: {
          currentRound: updatedRound,
        },
      });
    }
  };

  const resetCurrentRound = () => {
    dispatch({
      type: 'RESET_CURRENT_ROUND',
    });
  };

  const setRoundHistory = (newRoundHistory: Round[]) => {
    const clonedNewRoundHistory = [...newRoundHistory];
    dispatch({
      type: 'SET_ROUND_HISTORY',
      payload: {
        roundHistory: clonedNewRoundHistory,
      },
    });
  };

  const setFirstDealerOrder = (newFirstDealerOrder: string[]) => {
    const clonedNewFirstDealerOrder = [...newFirstDealerOrder];
    dispatch({
      type: 'SET_FIRST_DEALER_ORDER',
      payload: {
        firstDealerOrder: clonedNewFirstDealerOrder,
      },
    });
  };

  const setDealerOverride = (dealerOverride: string | null) => {
    dispatch({
      type: 'SET_DEALER_OVERRIDE',
      payload: {
        dealerOverride,
      },
    });
  };

  const resetRoundHistory = () => {
    dispatch({
      type: 'RESET_ROUND_HISTORY',
    });
  };

  const globalStore = {
    setCurrentRound,
    setRoundHistory,
    resetRoundHistory,
    resetCurrentRound,
    setFirstDealerOrder,
    setDealerOverride,
    firstDealerOrder: state.firstDealerOrder,
    currentRound: state.currentRound,
    roundHistory: state.roundHistory,
    isFirstGameAmongTeammates: state.isFirstGameAmongTeammates,
  };

  return (
    <GlobalContext.Provider value={globalStore}>
      {children}
    </GlobalContext.Provider>
  );
};
